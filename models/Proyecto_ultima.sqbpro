<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="Proyecto_ultima.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="0"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="2374"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="articulos" custom_title="0" dock_id="1" table="4,9:mainarticulos"/><dock_state state="000000ff00000000fd00000001000000020000000000000000fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000ffffffff0000011e00ffffff000000000000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings/></tab_browse><tab_sql><sql name="SQL 1*">-- Habilitar la integridad referencial
PRAGMA foreign_keys = ON;

---------------------------------
-- TABLA BASE
---------------------------------
CREATE TABLE IF NOT EXISTS persona(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    documento_identidad TEXT UNIQUE,
    primer_nombre TEXT NOT NULL,
    segundo_nombre TEXT,
    primer_apellido TEXT NOT NULL,
    segundo_apellido TEXT,
    genero TEXT CHECK(genero IN('M', 'F')),
    direccion TEXT NOT NULL,
    telefono TEXT NOT NULL UNIQUE,
    fecha_registro DATE DEFAULT CURRENT_DATE,
    activo BOOLEAN DEFAULT TRUE
);

---------------------------------
-- TABLAS ESPECIALIZADAS (PERSONA)
---------------------------------
CREATE TABLE IF NOT EXISTS nna(
    persona_id INTEGER PRIMARY KEY,
    fecha_nacimiento DATE NOT NULL CHECK(fecha_nacimiento &lt;= CURRENT_DATE),
    FOREIGN KEY (persona_id) REFERENCES persona(id) ON DELETE CASCADE
);

-- MODIFICACIÓN CLAVE: Agregar parentesco_id y su FK
CREATE TABLE IF NOT EXISTS familiar(
    persona_id INTEGER PRIMARY KEY,
    tutor BOOLEAN DEFAULT FALSE,
    parentesco_id INTEGER NOT NULL, 
    FOREIGN KEY (persona_id) REFERENCES persona(id) ON DELETE CASCADE,
    FOREIGN KEY (parentesco_id) REFERENCES parentesco(id)
);

CREATE TABLE IF NOT EXISTS tercero(
    persona_id INTEGER PRIMARY KEY,
    relacion_nna TEXT CHECK (relacion_nna IN('VECINO', 'DOCENTE', 'ENTIDAD_JURIDICA', 'OTRO')),
    FOREIGN KEY (persona_id) REFERENCES persona(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS personal(
    persona_id INTEGER PRIMARY KEY,
    cargo INTEGER,
    resolucion TEXT, -- Unicamente para consejeros
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (persona_id) REFERENCES persona(id) ON DELETE CASCADE,
    FOREIGN KEY (cargo) REFERENCES cargo(id)
);

---------------------------------
-- TABLA DE AUTENTICACIÓN (FALTANTE)
---------------------------------
CREATE TABLE IF NOT EXISTS usuario(
    persona_id INTEGER PRIMARY KEY,
    nombre_usuario TEXT NOT NULL,
    password_hash TEXT NOT NULL,
    FOREIGN KEY (persona_id) REFERENCES persona(id) ON DELETE CASCADE
);

---------------------------------
-- TABLAS DE RELACIONES
---------------------------------
CREATE TABLE IF NOT EXISTS relacion_nna(
    nna_id INTEGER,
    familiar_id INTEGER,
    parentesco INTEGER,
    convive BOOLEAN DEFAULT TRUE NOT NULL,
    PRIMARY KEY (nna_id, familiar_id, parentesco),
    FOREIGN KEY (nna_id) REFERENCES nna(persona_id),
    FOREIGN KEY (familiar_id) REFERENCES familiar(persona_id),
    FOREIGN KEY (parentesco) REFERENCES parentesco(id)
);

CREATE TABLE IF NOT EXISTS unidad_educativa(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    director TEXT NOT NULL,
    tipo TEXT CHECK(tipo IN('PUBLICA', 'PRIVADA')),
    direccion TEXT NOT NULL, 
    telefono TEXT NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS matricula_educativa(
    nna_id INTEGER,
    unidad_id INTEGER,
    grado TEXT,
    fecha_matricula DATE DEFAULT CURRENT_DATE,
    activa BOOLEAN DEFAULT TRUE,
    PRIMARY KEY (nna_id, unidad_id),
    FOREIGN KEY (nna_id) REFERENCES nna(persona_id),
    FOREIGN KEY (unidad_id) REFERENCES unidad_educativa(id)
);

CREATE TABLE IF NOT EXISTS articulos(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    codigo TEXT UNIQUE NOT NULL,
    articulo TEXT NOT NULL,
    descripcion TEXT NOT NULL
); 

CREATE TABLE IF NOT EXISTS expediente(
    nna_id INTEGER,
    articulo_id INTEGER,
    tipo TEXT CHECK(tipo IN('PROTECCION', 'TRAMITE_ADMINISTRATIVO', 'ASESORIA')) NOT NULL,
    fecha_realizacion DATE DEFAULT CURRENT_DATE,
    PRIMARY KEY (nna_id, articulo_id, tipo),
    FOREIGN KEY (nna_id) REFERENCES nna(persona_id),
    FOREIGN KEY (articulo_id) REFERENCES articulos(id)  
);

---------------------------------
-- TABLAS DE DENUNCIA
---------------------------------
CREATE TABLE IF NOT EXISTS denuncia(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    consejero_id INTEGER,
    fecha_denuncia DATE DEFAULT CURRENT_DATE,
    fecha_hechos DATE NOT NULL,
    descripcion TEXT NOT NULL,
    estado BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (consejero_id) REFERENCES personal(persona_id)
);

CREATE TABLE IF NOT EXISTS nna_involucrado(
    denuncia_id INTEGER NOT NULL,
    nna_id INTEGER NOT NULL,
    rol TEXT CHECK(rol IN('VICTIMA', 'AGRESOR', 'TESTIGO')),
    detalle_participacion TEXT,
    PRIMARY KEY (denuncia_id, nna_id),
    FOREIGN KEY (denuncia_id) REFERENCES denuncia(id),
    FOREIGN KEY (nna_id) REFERENCES nna(persona_id)
);

CREATE TABLE IF NOT EXISTS denunciante(
    denuncia_id INTEGER NOT NULL,
    persona_id INTEGER, -- Puede ser NULL si es anónimo
    declaracion TEXT NOT NULL,
    lesiones TEXT, 
    PRIMARY KEY (denuncia_id, persona_id),
    FOREIGN KEY (denuncia_id) REFERENCES denuncia(id) ON DELETE CASCADE,
    FOREIGN KEY (persona_id) REFERENCES persona(id)
);

CREATE TABLE IF NOT EXISTS denunciado(
    denuncia_id INTEGER NOT NULL,
    persona_id INTEGER NOT NULL, 
    medidas TEXT, 
    PRIMARY KEY (denuncia_id, persona_id),
    FOREIGN KEY (denuncia_id) REFERENCES denuncia(id),
    FOREIGN KEY (persona_id) REFERENCES persona(id)
);

-- CORRECCIÓN: Se alinea esta tabla con la definición de PostgreSQL (expediente_id, comentario, fecha)
CREATE TABLE IF NOT EXISTS seguimiento(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    expediente_id INTEGER NOT NULL, -- Referencia a un Expediente
    fecha DATE NOT NULL,
    comentario TEXT,
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS cierre(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    denuncia_id INTEGER NOT NULL UNIQUE,
    consejero_id INTEGER NOT NULL,
    fecha_cierre DATE DEFAULT CURRENT_DATE,
    acta_cierre TEXT NOT NULL,
    FOREIGN KEY (denuncia_id) REFERENCES denuncia(id) ON DELETE CASCADE,
    FOREIGN KEY (consejero_id) REFERENCES personal(persona_id)
);

---------------------------------
-- ENTIDADES CATALOGO
---------------------------------
CREATE TABLE IF NOT EXISTS parentesco(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL UNIQUE,
    descripcion TEXT
);

CREATE TABLE IF NOT EXISTS cargo(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL UNIQUE,
    requiere_resolucion BOOLEAN DEFAULT FALSE
);</sql><current_tab id="0"/></tab_sql></sqlb_project>
